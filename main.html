<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drawing Board</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        header {
            width: 100%;
            padding: 10px;
            background-color: #333;
            color: white;
            text-align: center;
            font-size: 1.5rem;
        }

        .tools {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        button,
        select,
        input[type="color"],
        input[type="text"] {
            padding: 10px;
            font-size: 1rem;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        button {
            background-color: #333;
            color: white;
        }

        button.active {
            background-color: #007BFF;
            color: white;
        }

        button:hover {
            background-color: #555;
        }

        canvas {
            border: 2px solid #333;
            margin-bottom: 20px;
            max-width: 100%;
            height: auto;
        }

        .drawing-board {
            background-color: white;
        }

        .layer {
            background-color: transparent;
        }

        .gallery {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
        }

        .gallery-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .gallery-item img {
            border: 2px solid #333;
            max-width: 100px;
            height: auto;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .tools {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>Drawing Board</h1>
    </header>

    <div class="tools">
        <label for="color">Color:</label>
        <input type="color" id="color" value="#000000">

        <label for="size">Size:</label>
        <select id="size">
            <option value="2">2</option>
            <option value="5" selected>5</option>
            <option value="10">10</option>
            <option value="20">20</option>
        </select>

        <button id="clear">Clear</button>
        <input type="text" id="save-name" placeholder="Enter name">
        <button id="save">Save</button>
        <button data-tool="rectangle">Rectangle</button>
        <button data-tool="circle">Circle</button>
        <button data-tool="eraser">Eraser</button>
        <button data-tool="pencil" class="active">Pencil</button>

        <button id="add-layer">Add Layer</button>
        <button id="delete-layer">Delete Layer</button>
    </div>

    <canvas id="drawing-board" width="800" height="600"></canvas>

    <div class="gallery" id="gallery"></div>

    <script>
        const canvas = document.getElementById('drawing-board');
        let ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('color');
        const sizeSelector = document.getElementById('size');
        const clearButton = document.getElementById('clear');
        const saveButton = document.getElementById('save');
        const loadButton = document.getElementById('load');
        const saveNameInput = document.getElementById('save-name');
        const gallery = document.getElementById('gallery');
        const toolButtons = document.querySelectorAll('button[data-tool]');
        const addLayerBtn = document.getElementById("add-layer");
        const deleteLayerBtn = document.getElementById("delete-layer");

        const drawLayers = () => {
            const mainCtx = canvas.getContext('2d');
            mainCtx.clearRect(0, 0, canvas.width, canvas.height);
            layers.forEach(layer => {
                mainCtx.drawImage(layer, 0, 0);
            });
        }

        const addLayer = () => {
            const newLayer = document.createElement('canvas');
            newLayer.width = canvas.width;
            newLayer.height = canvas.height;
            newLayer.classList.add('layer');
            layers.push(newLayer);
            currentLayer = layers.length - 1;
            ctx = layers[currentLayer].getContext('2d');
            drawLayers();
        }

        const deleteLayer = () => {
            if (layers.length > 1) {
                layers.pop();
                currentLayer = layers.length - 1;
                ctx = layers[currentLayer].getContext('2d');
                drawLayers();
            } else {
                alert('Cannot delete the last layer');
            }
        }

        let previousDrawing = null;
        let layers = [];
        let currentLayer = 0;
        addLayer();


        const tools = {
            pencil: {
                start: () => {
                    console.log('Pencil started');
                },
                move: (e) => {
                    if (!state.drawing) return;
                    const { x, y } = getPosition(e);
                    console.log(`Drawing pencil to (${x}, ${y})`);
                    ctx.lineWidth = state.size;
                    ctx.strokeStyle = state.color;
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                },
                end: () => {
                    console.log('Pencil ended');
                    ctx.beginPath();
                }
            },
            rectangle: {
                start: (e) => {
                    const { x, y } = getPosition(e);
                    state.startX = x;
                    state.startY = y;
                    console.log(`Rectangle start at (${x}, ${y})`);
                    previousDrawing = ctx.getImageData(0, 0, canvas.width, canvas.height);
                },
                move: (e) => {
                    if (previousDrawing) {
                        ctx.putImageData(previousDrawing, 0, 0);
                    }
                    const { x, y } = getPosition(e);
                    const width = x - state.startX;
                    const height = y - state.startY;
                    console.log(`Rectangle preview from (${state.startX}, ${state.startY}) to (${x}, ${y})`);
                    ctx.lineWidth = state.size;
                    ctx.strokeStyle = state.color;
                    ctx.strokeRect(state.startX, state.startY, width, height);
                },
                end: (e) => {
                    if (previousDrawing) {
                        ctx.putImageData(previousDrawing, 0, 0);
                    }
                    previousDrawing = null;
                    const { x, y } = getPosition(e);
                    const width = x - state.startX;
                    const height = y - state.startY;
                    console.log(`Rectangle drawn from (${state.startX}, ${state.startY}) to (${x}, ${y})`);
                    ctx.lineWidth = state.size;
                    ctx.strokeStyle = state.color;
                    ctx.strokeRect(state.startX, state.startY, width, height);
                }
            },
            circle: {
                start: (e) => {
                    const { x, y } = getPosition(e);
                    state.startX = x;
                    state.startY = y;
                    console.log(`Circle start at (${x}, ${y})`);
                    previousDrawing = ctx.getImageData(0, 0, canvas.width, canvas.height);
                },
                move: (e) => {
                    if (previousDrawing) {
                        ctx.putImageData(previousDrawing, 0, 0);
                    }
                    const { x, y } = getPosition(e);
                    const radius = Math.sqrt(Math.pow(x - state.startX, 2) + Math.pow(y - state.startY, 2));
                    console.log(`Circle preview with radius: ${radius}`);
                    ctx.lineWidth = state.size;
                    ctx.strokeStyle = state.color;
                    ctx.beginPath();
                    ctx.arc(state.startX, state.startY, radius, 0, Math.PI * 2);
                    ctx.stroke();
                },
                end: (e) => {
                    if (previousDrawing) {
                        ctx.putImageData(previousDrawing, 0, 0);
                    }
                    previousDrawing = null;
                    const { x, y } = getPosition(e);  // Ensure this is using the last known valid position
                    const radius = Math.sqrt(Math.pow(x - state.startX, 2) + Math.pow(y - state.startY, 2));
                    console.log(`Circle drawn with radius: ${radius}`);
                    ctx.lineWidth = state.size;
                    ctx.strokeStyle = state.color;
                    ctx.beginPath();
                    ctx.arc(state.startX, state.startY, radius, 0, Math.PI * 2);
                    ctx.stroke();
                }
            },
            eraser: {
                start: () => {
                    console.log('Eraser started');
                },
                move: (e) => {
                    if (!state.drawing) return;
                    const { x, y } = getPosition(e);
                    console.log(`Erasing at (${x}, ${y})`);
                    ctx.lineWidth = state.size;
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.moveTo(x, y);
                },
                end: () => {
                    console.log('Eraser ended');
                    ctx.beginPath();
                }
            }
        };

        const state = {
            tool: 'pencil',
            color: colorPicker.value,
            size: parseInt(sizeSelector.value),
            drawing: false,
            startX: 0,
            startY: 0
        };

        const getPosition = (e) => {
            console.log(e);
            const rect = canvas.getBoundingClientRect();
            let x, y;

            if (e.touches && e.touches.length > 0) {
                // Handle touch events
                x = e.touches[0].clientX;
                y = e.touches[0].clientY;
            } else if (e.clientX && e.clientY) {
                // Handle mouse events
                x = e.clientX;
                y = e.clientY;
            } else if (e.changedTouches && e.changedTouches.length > 0) {
                x = e.changedTouches[0].clientX;
                y = e.changedTouches[0].clientY;
            } else {
                return { x: 0, y: 0 }; // Return 0,0 if no valid position found
            }

            return { x: x - rect.left, y: y - rect.top };
        };


        const setTool = (tool) => {
            console.log(`Tool set to: ${tool}`);
            state.tool = tool;
            toolButtons.forEach(button => button.classList.remove('active'));
            document.querySelector(`button[data-tool="${tool}"]`).classList.add('active');
        };

        const startDrawing = (e) => {
            console.log('Drawing started');
            state.drawing = true;
            tools[state.tool].start(e);
        };

        const draw = (e) => {
            if (state.drawing) {
                console.log('Drawing...');
                tools[state.tool].move(e);
                drawLayers();
            }
        };

        const stopDrawing = (e) => {
            if (!state.drawing) return;
            console.log('Drawing stopped');
            tools[state.tool].end(e);
            state.drawing = false;
            drawLayers();
        };

        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startDrawing(e);
        });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            draw(e);
        });

        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            stopDrawing(e);
        });

        clearButton.addEventListener('click', () => {
            console.log('Canvas cleared');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        });

        const updateGallery = () => {
            console.log('Updating gallery...');
            gallery.innerHTML = '';
            const drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
            drawings.forEach((drawing, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';

                const img = document.createElement('img');
                img.src = drawing.data;
                img.alt = drawing.name;
                img.addEventListener('click', () => {
                    console.log('Loading image from gallery');
                    const imgToLoad = new Image();
                    imgToLoad.src = drawing.data;
                    imgToLoad.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(imgToLoad, 0, 0);
                    };
                });

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => {
                    console.log('Deleting drawing from gallery');
                    drawings.splice(index, 1);
                    localStorage.setItem('drawings', JSON.stringify(drawings));
                    updateGallery();
                });
                item.addEventListener('mouseenter', () => item.appendChild(deleteButton));
                item.addEventListener('mouseleave', () => item.removeChild(deleteButton));
                item.style.position = 'relative';
                const label = document.createElement('span');
                label.textContent = drawing.name;

                item.appendChild(img);
                item.appendChild(label);
                gallery.appendChild(item);
            });
        };

        saveButton.addEventListener('click', () => {
            const name = saveNameInput.value.trim();
            if (!name) {
                alert('Please enter a name for your drawing!');
                return;
            }

            const dataURL = canvas.toDataURL();
            const drawings = JSON.parse(localStorage.getItem('drawings') || '[]');
            drawings.push({ name, data: dataURL });
            localStorage.setItem('drawings', JSON.stringify(drawings));
            updateGallery();
            alert('Drawing saved!');
        });

        toolButtons.forEach((button) => {
            button.addEventListener('click', () => {
                setTool(button.getAttribute('data-tool'));
            });
        });

        colorPicker.addEventListener('input', (e) => {
            console.log(`Color changed to: ${e.target.value}`);
            state.color = e.target.value;
        });

        sizeSelector.addEventListener('input', (e) => {
            console.log(`Size changed to: ${e.target.value}`);
            state.size = parseInt(e.target.value);
        });

        addLayerBtn.addEventListener('click', addLayer);
        deleteLayerBtn.addEventListener('click', deleteLayer);


        updateGallery();
    </script>

</body>

</html>